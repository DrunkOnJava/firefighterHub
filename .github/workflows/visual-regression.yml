name: "Visual Regression Testing"

# Capture and compare visual snapshots using Playwright
# Runs on: PRs affecting UI components, pushes to main

on:
  pull_request:
    paths:
      - 'src/components/**'
      - 'src/styles/**'
      - 'src/**/*.css'
  push:
    branches: [main]
    paths:
      - 'src/components/**'
      - 'src/styles/**'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  visual-regression:
    name: Visual Regression Test
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need history for base comparison

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: pnpm exec playwright install chromium --with-deps

      - name: Build application
        run: pnpm build
        env:
          NODE_ENV: production

      - name: Start preview server
        run: |
          pnpm preview &
          echo $! > .preview-pid

          # Wait for server to be ready
          timeout 60 bash -c 'until curl -s http://localhost:4173 > /dev/null; do sleep 1; done'
          echo "âœ… Preview server ready on port 4173"

      - name: Capture visual snapshots
        run: |
          mkdir -p visual-snapshots

          # Responsive breakpoints from environment
          BREAKPOINTS=(375 768 1024 1920)

          # Key pages to snapshot
          PAGES=(
            ""                    # Homepage (calendar)
            "?shift=A"           # Shift A view
            "?shift=B"           # Shift B view
            "?shift=C"           # Shift C view
          )

          for breakpoint in "${BREAKPOINTS[@]}"; do
            for page in "${PAGES[@]}"; do
              # Generate filename
              PAGE_NAME=$(echo "$page" | sed 's/[^a-zA-Z0-9]/-/g' | sed 's/^-//' | sed 's/-$//')
              if [ -z "$PAGE_NAME" ]; then
                PAGE_NAME="home"
              fi

              FILENAME="visual-snapshots/${PAGE_NAME}-${breakpoint}px.png"

              echo "ðŸ“¸ Capturing: $FILENAME"

              # Capture screenshot with Playwright
              pnpm exec playwright screenshot \
                "http://localhost:4173${page}" \
                "$FILENAME" \
                --viewport-size="${breakpoint},1080" \
                --full-page \
                --wait-for-selector="body" \
                --timeout=10000 || echo "âš ï¸ Failed to capture $FILENAME"
            done
          done

          echo "âœ… Visual snapshots captured"

      - name: Capture component-specific snapshots
        run: |
          # Calendar components at different states
          CALENDAR_VIEWS=(
            "Calendar-empty"
            "Calendar-with-holds"
            "Sidebar-rotation"
            "ShiftSelector"
          )

          # Capture specific component states
          pnpm exec playwright screenshot \
            "http://localhost:4173" \
            "visual-snapshots/calendar-main-1920px.png" \
            --viewport-size="1920,1080" \
            --full-page

          echo "âœ… Component snapshots captured"

      - name: Generate snapshot manifest
        run: |
          {
            echo "# Visual Snapshot Manifest"
            echo ""
            echo "**Generated:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
            echo "**Commit:** ${{ github.sha }}"
            echo "**Branch:** ${{ github.ref_name }}"
            echo ""
            echo "## Snapshots"
            echo ""
            find visual-snapshots -name "*.png" | sort | while read snapshot; do
              SIZE=$(du -h "$snapshot" | cut -f1)
              FILENAME=$(basename "$snapshot")
              echo "- \`$FILENAME\` ($SIZE)"
            done
          } > visual-snapshots/MANIFEST.md

      - name: Compare with base (PR only)
        if: github.event_name == 'pull_request'
        run: |
          echo "ðŸ”„ Comparing with base branch..."

          # Checkout base branch
          git fetch origin ${{ github.base_ref }}
          git checkout origin/${{ github.base_ref }}

          # Rebuild and capture base snapshots
          pnpm install --frozen-lockfile
          pnpm build
          pnpm preview &
          BASE_PID=$!

          sleep 5

          mkdir -p visual-snapshots-base

          # Capture key snapshots for comparison
          pnpm exec playwright screenshot \
            "http://localhost:4173" \
            "visual-snapshots-base/home-1920px.png" \
            --viewport-size="1920,1080" \
            --full-page || true

          pnpm exec playwright screenshot \
            "http://localhost:4173" \
            "visual-snapshots-base/home-375px.png" \
            --viewport-size="375,667" \
            --full-page || true

          kill $BASE_PID || true

          # Return to PR branch
          git checkout -

          echo "âœ… Base snapshots captured"

      - name: Analyze visual differences
        if: github.event_name == 'pull_request'
        run: |
          # Install pixelmatch for image comparison
          pnpm add -D pixelmatch pngjs

          # Create comparison script
          cat > compare-images.js << 'SCRIPT'
          const fs = require('fs');
          const PNG = require('pngjs').PNG;
          const pixelmatch = require('pixelmatch');

          const img1 = PNG.sync.read(fs.readFileSync(process.argv[2]));
          const img2 = PNG.sync.read(fs.readFileSync(process.argv[3]));
          const {width, height} = img1;
          const diff = new PNG({width, height});

          const numDiffPixels = pixelmatch(
            img1.data, img2.data, diff.data, width, height,
            {threshold: 0.1}
          );

          const totalPixels = width * height;
          const percentDiff = (numDiffPixels / totalPixels) * 100;

          console.log(JSON.stringify({
            totalPixels,
            diffPixels: numDiffPixels,
            percentDiff: percentDiff.toFixed(2)
          }));
          SCRIPT

          # Compare snapshots
          mkdir -p visual-diffs

          COMPARISONS=(
            "home-1920px.png"
            "home-375px.png"
          )

          TOTAL_DIFF=0
          COMPARISON_COUNT=0

          for snapshot in "${COMPARISONS[@]}"; do
            if [ -f "visual-snapshots/$snapshot" ] && [ -f "visual-snapshots-base/$snapshot" ]; then
              echo "ðŸ” Comparing: $snapshot"

              RESULT=$(node compare-images.js \
                "visual-snapshots-base/$snapshot" \
                "visual-snapshots/$snapshot" 2>/dev/null || echo '{"percentDiff":"0"}')

              PERCENT=$(echo "$RESULT" | jq -r '.percentDiff')
              TOTAL_DIFF=$(echo "$TOTAL_DIFF + $PERCENT" | bc)
              COMPARISON_COUNT=$((COMPARISON_COUNT + 1))

              echo "  Difference: ${PERCENT}%"
            fi
          done

          # Calculate average difference
          if [ $COMPARISON_COUNT -gt 0 ]; then
            AVG_DIFF=$(echo "scale=2; $TOTAL_DIFF / $COMPARISON_COUNT" | bc)
            echo "average_diff=$AVG_DIFF" >> $GITHUB_ENV
            echo ""
            echo "ðŸ“Š Average visual difference: ${AVG_DIFF}%"
          else
            echo "average_diff=0" >> $GITHUB_ENV
          fi

      - name: Upload visual snapshots
        uses: actions/upload-artifact@v4
        with:
          name: visual-snapshots-${{ github.sha }}
          path: |
            visual-snapshots/
            visual-snapshots-base/
            visual-diffs/
          retention-days: 30

      - name: Comment on PR with visual diff
        if: github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          {
            echo "## ðŸ“¸ Visual Regression Test Results"
            echo ""
            echo "**Average Visual Difference:** ${average_diff:-0}%"
            echo ""

            if (( $(echo "${average_diff:-0} < 1" | bc -l) )); then
              echo "### âœ… No Significant Visual Changes Detected"
              echo ""
              echo "Visual appearance is consistent with base branch."
            elif (( $(echo "${average_diff:-0} < 5" | bc -l) )); then
              echo "### âš ï¸ Minor Visual Changes Detected"
              echo ""
              echo "Small visual differences detected. Please review snapshots to ensure changes are intentional."
            else
              echo "### ðŸ” Significant Visual Changes Detected"
              echo ""
              echo "Notable visual differences detected. Please review carefully."
            fi

            echo ""
            echo "### ðŸ“Š Snapshots Captured"
            echo ""
            echo "- Desktop (1920px)"
            echo "- Tablet (768px)"
            echo "- Mobile (375px)"
            echo ""
            echo "**View artifacts:** [Visual Snapshots](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          } > visual-diff-comment.md

          gh pr comment ${{ github.event.pull_request.number }} \
            --body-file visual-diff-comment.md \
            || echo "Could not comment on PR"

      - name: Stop preview server
        if: always()
        run: |
          if [ -f .preview-pid ]; then
            kill $(cat .preview-pid) || true
          fi

      - name: Job summary
        if: always()
        run: |
          {
            echo "## ðŸ“¸ Visual Regression Summary"
            echo ""
            echo "| Check | Result |"
            echo "|-------|--------|"
            echo "| Snapshots Captured | âœ… Yes |"
            echo "| Design Token Usage | ${{ steps.usage.outputs.percentage }}% |"
            echo "| Arbitrary Values | $([ "${{ steps.scan.outputs.violations }}" = "false" ] && echo "âœ… None" || echo "âŒ ${{ steps.scan.outputs.count }}") |"

            if [ "${{ github.event_name }}" = "pull_request" ]; then
              echo "| Visual Difference | ${average_diff:-N/A}% |"
            fi

            echo ""
            echo "**Artifacts:** Visual snapshots uploaded for 30 days"
          } >> $GITHUB_STEP_SUMMARY
